#!/bin/bash

# Change to the repository root directory
cd "$(git rev-parse --show-toplevel)" || exit 1

# Get the current UTC date and time
DATE=$(date -u +"%Y-%m-%d")
TIME=$(date -u +"%H:%M:%S")
REPLACEMENT="${DATE}T${TIME}Z"

# Get list of staged files in src/posts/ excluding _PostTemplate.md
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^src/posts/" | grep -v "_PostTemplate.md")

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Process each file
# Use a temporary file to avoid subshell issues
TMPFILE=$(mktemp)
git diff --cached --name-only --diff-filter=ACM | grep "^src/posts/" | grep -v "_PostTemplate.md" > "$TMPFILE"

while IFS= read -r file; do
    if [ -n "$file" ] && [ -f "$file" ]; then
        # Check if file contains the placeholder
        if grep -q "THEDATETTHETIMEZ" "$file"; then
            # Replace the placeholder with current UTC date/time
            sed -i '' "s/THEDATETTHETIMEZ/$REPLACEMENT/g" "$file"
            # Stage the modified file
            git add "$file"
            echo "Updated date/time in $file"
        fi
    fi
done < "$TMPFILE"

rm -f "$TMPFILE"

exit 0
